/**
 * Postinstall script: patches node-pty's gyp files so it can build on Windows
 * without Spectre-mitigated MSVC libraries and without relying on bat scripts
 * that fail under gyp's working directory.
 *
 * Patches applied:
 *   1. binding.gyp + winpty.gyp: Disable SpectreMitigation (most dev machines lack the libs)
 *   2. winpty.gyp: Replace bat script calls with proper include dir output
 *   3. Create gen/GenVersion.h so the C++ source compiles
 *
 * Only runs on win32 — no-ops on other platforms.
 */
'use strict';

if (process.platform !== 'win32') process.exit(0);

const fs = require('fs');
const path = require('path');

const nodePtyDir = path.join(__dirname, '..', 'node_modules', 'node-pty');
const winptySrcDir = path.join(nodePtyDir, 'deps', 'winpty', 'src');

// --- 1. Create gen/GenVersion.h ---
const genDir = path.join(winptySrcDir, 'gen');
if (!fs.existsSync(genDir)) {
  fs.mkdirSync(genDir, { recursive: true });
}

let version = '0.0.0';
try {
  version = fs.readFileSync(path.join(nodePtyDir, 'deps', 'winpty', 'VERSION.txt'), 'utf-8').trim();
} catch {}

const genVersionH = `// AUTO-GENERATED by fix-node-pty-win.js
const char GenVersion_Version[] = "${version}";
const char GenVersion_Commit[] = "none";
`;
fs.writeFileSync(path.join(genDir, 'GenVersion.h'), genVersionH, 'utf-8');
console.log('[fix-node-pty-win] Created gen/GenVersion.h');

// --- 2. Patch gyp files ---
function patchFile(filePath, patches) {
  if (!fs.existsSync(filePath)) {
    console.log(`[fix-node-pty-win] ${path.basename(filePath)} not found — skipping`);
    return;
  }

  let content = fs.readFileSync(filePath, 'utf-8');
  const original = content;

  for (const { pattern, replacement } of patches) {
    if (pattern instanceof RegExp) {
      content = content.replace(pattern, replacement);
    } else {
      while (content.includes(pattern)) {
        content = content.replace(pattern, replacement);
      }
    }
  }

  if (content !== original) {
    fs.writeFileSync(filePath, content, 'utf-8');
    console.log(`[fix-node-pty-win] Patched ${path.basename(filePath)}`);
  } else {
    console.log(`[fix-node-pty-win] ${path.basename(filePath)} already patched`);
  }
}

// Patch winpty.gyp:
//   - Replace GetCommitHash.bat call with hardcoded "none"
//   - Replace UpdateGenVersion.bat call with "gen" (the include directory)
//   - Disable SpectreMitigation
patchFile(path.join(winptySrcDir, 'winpty.gyp'), [
  {
    pattern: /cmd\s*\/c\s*"cd shared && GetCommitHash\.bat"/g,
    replacement: 'cmd /c "echo none"',
  },
  {
    pattern: /cmd\s*\/c\s*"cd shared && UpdateGenVersion\.bat[^"]*"/g,
    replacement: 'cmd /c "echo gen"',
  },
  {
    // Handle case where a previous run already patched to "echo ok" instead of "echo gen"
    pattern: `'<!(cmd /c "echo ok")'`,
    replacement: `'<!(cmd /c "echo gen")'`,
  },
  {
    pattern: "'SpectreMitigation': 'Spectre'",
    replacement: "'SpectreMitigation': 'false'",
  },
]);

// Patch binding.gyp:
//   - Disable SpectreMitigation
patchFile(path.join(nodePtyDir, 'binding.gyp'), [
  {
    pattern: "'SpectreMitigation': 'Spectre'",
    replacement: "'SpectreMitigation': 'false'",
  },
]);
